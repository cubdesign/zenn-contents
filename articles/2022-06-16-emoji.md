---
title: "emojiçµµæ–‡å­—ã®è‰²ã‚’æŠ½å‡ºã—ã¦ã¿ãŸ"
emoji: "ğŸ¤¡"
type: "tech"
topics: ["nextjs", "react", "emoji"]
published: true
---

# ã¤ãã£ã¦ã¿ãŸ

ãƒ‡ãƒ¢ï¼š
https://node-vibrant-example.cubdesign.com/

ã‚½ãƒ¼ã‚¹ï¼š
https://github.com/cubdesign/node-vibrant-example

â†“ ã“ã†ã„ã†ã‚„ã¤

![](/images/2022-06-16-emoji/playground.png)

- emoji ã‚’å…¥åŠ›ã€ç”»åƒã‚’é¸æŠã—ã¦ãã‚Œãã‚Œã®ç›®ç«‹ã¤è‰²ã‚’æŠ½å‡ºã€‚
- ç”»åƒã¯ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã›ã™ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å‡¦ç†ã€‚
- çµµæ–‡å­—ã¯ apple ç³» â†’ apple emojiã€Android â†’ Google emojiã€ä»– â†’ twemoji ã‚’ãƒ‡ãƒã‚¤ã‚¹ã«ã‚ˆã£ã¦å‡ºã—ã‚ã‘ã€‚

# ã—ãã¿

è‰²ã®æŠ½å‡ºã¯ã€ç”»åƒã‹ã‚‰ç›®ç«‹ã¤ã®ã‚ã‚‹è‰²ã‚’æŠ½å‡ºã™ã‚‹ node.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
[`node-vibrant`](<(https://github.com/Vibrant-Colors/node-vibrant)>)ã‚’ä½¿ã†ã€‚

çµµæ–‡å­—ã‚’ãã®ã¾ã¾`node-vibrant`ã§æ‰±ã†ã“ã¨ãŒã§ããªã„ã®ã§ã€[twemoji-parser](https://github.com/twitter/twemoji-parser)ã‚’ä½¿ã£ã¦ã€çµµæ–‡å­—ã‚’ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã€‚ã‚³ãƒ¼ãƒ‰ã‚’å…ƒã« emoji database ã® cdn ã‹ã‚‰ç”»åƒã‚’å–å¾—ã—`node-vibrant`ã§æŠ½å‡ºã™ã‚‹ã€‚

ãƒ‡ãƒ¢ã§ã¯ã€æŠ½å‡ºã—ãŸè‰²ã®ä¸­ã‹ã‚‰ã€ãƒˆãƒƒãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚‚ã®ã‚’èƒŒæ™¯è‰²ã€‚æŠ½å‡ºã—ãŸè‰²ã§ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚Šã€çµµæ–‡å­—ã®èƒŒæ™¯ã¨ã—ã¦ã¿ãŸã€‚

## 1. çµµæ–‡å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—

â†“ ã“ã†ã„ã†å¤‰æ›

ğŸ‘¾ â†’ 1f47e

ğŸ™…ğŸ»â€â™‚ï¸ â†’ 1f645-1f3fb-200d-2642-fe0f

`twemoji-parser`ã§ã¯ã€ã‚³ãƒ¼ãƒ‰ãŒç›´æ¥å–å¾—ã§ããªã„ã®ã§ã€`twemoji-parser`ã§ã€çµµæ–‡å­—ã®ç”»åƒã‚’å–å¾—ã—ã¦ã€ç”»åƒ URL ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã€‚

```ts
import { EmojiEntity, parse } from "twemoji-parser";

export type Emoji = {
  text: string;
  unicode: string;
  brand: EmojiBrand;
  imageUrl: string;
};

/**
 * çµµæ–‡å­—ã®ç”»åƒURLã‹ã‚‰unicodeãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
 *
 * @param emojiImageURL çµµæ–‡å­—ã®ç”»åƒURL
 * @returns
 */
const getUnicodeFromEmojiImageURL = (emojiImageURL: string): string => {
  return emojiImageURL.replace(/.*\/(.*)\.(png|svg)/, "$1");
};

/**
 * çµµæ–‡å­—ã®ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹
 *
 * @param emoji çµµæ–‡å­—ï¼ˆè¤‡æ•°å¯ï¼‰
 */
const getEmojis = (emoji: string, ua: string): Emoji[] => {
  const emojiBrand: EmojiBrand = getEmojiBrandByUA(ua);

  const emojiEntities: EmojiEntity[] = parse(emoji, {
    buildUrl: (codepoints: string, assetType: string): string => {
      return assetType === "png"
        ? `https://cdn.jsdelivr.net/npm/emoji-datasource-${emojiBrand}@14.0.0/img/${emojiBrand}/64/${codepoints}.png`
        : `https://twemoji.maxcdn.com/v/latest/svg/${codepoints}.svg`;
    },
    assetType: "png",
  });

  const emojis: Emoji[] = [];

  for (let i: number = 0; i < emojiEntities.length; i++) {
    const emojiEntity: EmojiEntity = emojiEntities[i];

    emojis.push({
      text: emojiEntity.text,
      unicode: getUnicodeFromEmojiImageURL(emojiEntity.url),
      brand: emojiBrand,
      imageUrl: emojiEntity.url,
    });
  }

  return emojis;
};
```

## 2. çµµæ–‡å­—ã®ç”»åƒ URL ã‚’å–å¾—

`twemoji-parser`ã§çµµæ–‡å­—ã®ç”»åƒ URL ã‚’ä½œæˆã™ã‚‹ã€‚
ã€€ç”»åƒã¯ã€[emoji-data](https://github.com/iamcal/emoji-data) ã® cdn ã‚’ä½¿ç”¨ã€‚64x64 ã® pngã€‚

```
ğŸ‘¾ = {
    emojiBrand:  "apple" | "google" | "twitter",
    codepoints: "1f47e"
}
```

â†“

```
https://cdn.jsdelivr.net/npm/emoji-datasource-${emojiBrand}@14.0.0/img/${emojiBrand}/64/${codepoints}.png
```

```ts
import { EmojiEntity, parse } from "twemoji-parser";

const getEmojiBrandByUA = (ua: string): EmojiBrand => {
  if (isApple(ua)) {
    return "apple";
  }
  if (isAndroid(ua)) {
    return "google";
  }

  // appleãƒ‡ãƒã‚¤ã‚¹ã€ã‚¢ãƒ³ãƒ‰ãƒ­ã‚¤ãƒ‰ä»¥å¤–ã¯Twitterã¨ã™ã‚‹
  return "twitter";
};

const emojiBrand: EmojiBrand = getEmojiBrandByUA(ua);

const emojiEntities: EmojiEntity[] = parse(emoji, {
  buildUrl: (codepoints: string, assetType: string): string => {
    return assetType === "png"
      ? `https://cdn.jsdelivr.net/npm/emoji-datasource-${emojiBrand}@14.0.0/img/${emojiBrand}/64/${codepoints}.png`
      : `https://twemoji.maxcdn.com/v/latest/svg/${codepoints}.svg`;
  },
  assetType: "png",
});
```

## 3. çµµæ–‡å­—ã®è‰²ã‚’æŠ½å‡º

`node-vibrant`ã«çµµæ–‡å­—ç”»åƒã® URL ã‚’æ¸¡ã—è‰²ã‚’æŠ½å‡ºã™ã‚‹ã€‚6 è‰²æŠ½å‡ºã•ã‚Œã‚‹ã€‚

```ts
import Vibrant from "node-vibrant";

const palette: Palette = await Vibrant.from(imageURL)
  .quality(quality)
  .getPalette();
```

# ã¯ã¾ã£ãŸã“ã¨

`worker.js`ã‚¨ãƒ©ãƒ¼ãŒã‚ã¡ã‚ƒãã¡ã‚ƒã§ã¦ã€åŸå› ä¸æ˜ã§æ‚©ã‚“ã§ã„ãŸã¨ã“ã‚ã€`node-vibrant`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å•é¡Œã ã£ãŸã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ãŒã§ãªããªã£ãŸã€‚ï¼ˆ2022.06.16ï¼‰

â†“

`"node-vibrant": "^3.2.1-alpha.1"` -> `"node-vibrant": "^3.1.6"`

è©³ã—ãã¯ã€ã“ã“ â†“

https://github.com/Vibrant-Colors/node-vibrant/issues/113

# ã¤ã‹ã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- [node-vibrant ï¼ˆè‰²ã®æŠ½å‡ºï¼‰](https://github.com/Vibrant-Colors/node-vibrant)
- [emoji-data (çµµæ–‡å­—ç”»åƒã‚’ cdn ã‹ã‚‰å€Ÿç”¨)](https://github.com/iamcal/emoji-data)
- [twemoji-parser (çµµæ–‡å­—ã®ãƒ‘ãƒ¼ã‚¹)](https://github.com/twitter/twemoji-parser)

æ„å›³ã—ãŸè‰²ãŒæŠ½å‡ºã•ã‚Œã‚‹å ´åˆã¨ã€ãã†ã§ãªã„æ™‚ãŒã‚ã‚Šã€å¾®å¦™ã ã£ãŸã€‚
